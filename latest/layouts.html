<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Optimal Layouts · DataKnots.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DataKnots.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search.html"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="index.html">Home</a></li><li><a class="toctext" href="install.html">Installation Instructions</a></li><li><a class="toctext" href="usage.html">Usage Guide</a></li><li><a class="toctext" href="implementation.html">Implementation Guide</a><ul><li class="current"><a class="toctext" href="layouts.html">Optimal Layouts</a><ul class="internal"><li><a class="toctext" href="#Overview-1">Overview</a></li><li><a class="toctext" href="#API-Reference-1">API Reference</a></li><li><a class="toctext" href="#Test-Suite-1">Test Suite</a></li></ul></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href="implementation.html">Implementation Guide</a></li><li><a href="layouts.html">Optimal Layouts</a></li></ul><a class="edit-page" href="https://github.com/rbt-lang/DataKnots.jl/blob/master/doc/src/layouts.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Optimal Layouts</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Optimal-Layouts-1" href="#Optimal-Layouts-1">Optimal Layouts</a></h1><h2><a class="nav-anchor" id="Overview-1" href="#Overview-1">Overview</a></h2><p>In DataKnots.jl, we often need to visualize composite data structures or complex Julia expressions.  For this purpose, module <code>DataKnots.Layouts</code> implements a pretty-printing engine.</p><pre><code class="language-julia">using DataKnots.Layouts</code></pre><p>To format a data structure, we need to encode its possible layouts in the form of a <em>layout expression</em>.</p><p>A fixed single-line layout is created with <code>Layouts.literal()</code>.</p><pre><code class="language-julia">Layouts.literal(&quot;department&quot;)
#-&gt; literal(&quot;department&quot;)</code></pre><p>Layouts could be combined using horizontal and vertical composition operators.</p><pre><code class="language-julia">lhz = Layouts.literal(&quot;department&quot;) * Layouts.literal(&quot;.&quot;) * Layouts.literal(&quot;name&quot;)
#-&gt; literal(&quot;department.name&quot;)

lvt = Layouts.literal(&quot;department&quot;) / Layouts.literal(&quot;name&quot;)
#-&gt; literal(&quot;department&quot;) / literal(&quot;name&quot;)</code></pre><p>Function <code>Layouts.pretty_print()</code> serializes the layout.</p><pre><code class="language-julia">pretty_print(lhz)
#-&gt; department.name

pretty_print(lvt)
#=&gt;
department
name
=#</code></pre><p>To indicate that we can choose between several different layouts, use the choice operator.</p><pre><code class="language-julia">l = lhz | lvt
#-&gt; literal(&quot;department.name&quot;) | literal(&quot;department&quot;) / literal(&quot;name&quot;)</code></pre><p>The pretty-printing engine can search through possible layouts to find the best fit, which is expressed as a layout expression without a choice operator.</p><pre><code class="language-julia">Layouts.best(Layouts.fit(l))
#-&gt; literal(&quot;department.name&quot;)</code></pre><p>The module implements the optimal layout algorithm described in <a href="https://research.google.com/pubs/pub44667.html">https://research.google.com/pubs/pub44667.html</a>.</p><h2><a class="nav-anchor" id="API-Reference-1" href="#API-Reference-1">API Reference</a></h2><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DataKnots.Layouts.pretty_print" href="#DataKnots.Layouts.pretty_print"><code>DataKnots.Layouts.pretty_print</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">Layouts.pretty_print([io::IO], data)</code></pre><p>Formats the data so that it fits the width of the output screen.</p></div></div><a class="source-link" target="_blank" href="https://github.com/rbt-lang/DataKnots.jl/blob/9973f173b65a6ddaf8d6819185ff52e431db0e8f/src/layouts/Layouts.jl#L27-L31">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="DataKnots.Layouts.print_code" href="#DataKnots.Layouts.print_code"><code>DataKnots.Layouts.print_code</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-julia">Layouts.print_code([io::IO], code)</code></pre><p>Formats a Julia expression.</p></div></div><a class="source-link" target="_blank" href="https://github.com/rbt-lang/DataKnots.jl/blob/9973f173b65a6ddaf8d6819185ff52e431db0e8f/src/layouts/Layouts.jl#L43-L47">source</a></section><h2><a class="nav-anchor" id="Test-Suite-1" href="#Test-Suite-1">Test Suite</a></h2><p>We start with creating a simple tree structure.</p><pre><code class="language-julia">struct Node
    name::Symbol
    arms::Vector{Node}
end

Node(name) = Node(name, [])

tree =
    Node(:a, [Node(:an, [Node(:anchor, [Node(:anchorage), Node(:anchorite)]),
                           Node(:anchovy),
                           Node(:antic, [Node(:anticipation)])]),
               Node(:arc, [Node(:arch, [Node(:archduke), Node(:archer)])]),
               Node(:awl)])
#-&gt; Node(:a, Main.layouts.md.Node[ … ])</code></pre><p>To specify a layout expression for <code>Node</code> objects, we need to override <code>Layout.tile()</code>.  Layout expressions are assembled from <code>Layouts.literal()</code> primitives using operators <code>*</code> (horizontal composition), <code>/</code> (vertical composition), and <code>|</code> (choice).</p><pre><code class="language-julia">function Layouts.tile(tree::Node)
    if isempty(tree.arms)
        return Layouts.literal(&quot;Node($(repr(tree.name)))&quot;)
    end
    arm_lts = [Layouts.tile(arm) for arm in tree.arms]
    v_lt = h_lt = nothing
    for (k, arm_lt) in enumerate(arm_lts)
        if k == 1
            v_lt = arm_lt
            h_lt = Layouts.nobreaks(arm_lt)
        else
            v_lt = v_lt * Layouts.literal(&quot;,&quot;) / arm_lt
            h_lt = h_lt * Layouts.literal(&quot;, &quot;) * Layouts.nobreaks(arm_lt)
        end
    end
    return Layouts.literal(&quot;Node($(repr(tree.name)), [&quot;) *
           (v_lt | h_lt) *
           Layouts.literal(&quot;])&quot;)
end</code></pre><p>Now we can use function <code>pretty_print()</code> to render a nicely formatted representation of the tree.</p><pre><code class="language-julia">pretty_print(stdout, tree)
#=&gt;
Node(:a, [Node(:an, [Node(:anchor, [Node(:anchorage), Node(:anchorite)]),
                     Node(:anchovy),
                     Node(:antic, [Node(:anticipation)])]),
          Node(:arc, [Node(:arch, [Node(:archduke), Node(:archer)])]),
          Node(:awl)])
=#</code></pre><p>We can control the width of the output.</p><pre><code class="language-julia">pretty_print(IOContext(stdout, :displaysize =&gt; (24, 60)), tree)
#=&gt;
Node(:a, [Node(:an, [Node(:anchor, [Node(:anchorage),
                                    Node(:anchorite)]),
                     Node(:anchovy),
                     Node(:antic, [Node(:anticipation)])]),
          Node(:arc, [Node(:arch, [Node(:archduke),
                                   Node(:archer)])]),
          Node(:awl)])
=#</code></pre><p>We can display the layout expression itself, both the original and the optimized variants.</p><pre><code class="language-julia">Layouts.tile(tree)
#=&gt;
literal(&quot;Node(:a, [&quot;)
* (literal(&quot;Node(:an, [&quot;)
   * (literal(&quot;Node(:anchor, [&quot;)
   ⋮
=#

Layouts.best(Layouts.fit(stdout, Layouts.tile(tree)))
#=&gt;
literal(&quot;Node(:a, [&quot;)
* (literal(&quot;Node(:an, [&quot;)
   * (literal(&quot;Node(:anchor, [Node(:anchorage), Node(:anchorite)]),&quot;)
   ⋮
=#</code></pre><p>For some built-in data structures, automatic layout is already provided.</p><pre><code class="language-julia">data = [
    (name = &quot;RICHARD A&quot;, position = &quot;FIREFIGHTER&quot;, salary = 90018),
    (name = &quot;DEBORAH A&quot;, position = &quot;POLICE OFFICER&quot;, salary = 86520),
    (name = &quot;KATHERINE A&quot;, position = &quot;PERSONAL COMPUTER OPERATOR II&quot;, salary = 60780)
]

pretty_print(data)
#=&gt;
[(name = &quot;RICHARD A&quot;, position = &quot;FIREFIGHTER&quot;, salary = 90018),
 (name = &quot;DEBORAH A&quot;, position = &quot;POLICE OFFICER&quot;, salary = 86520),
 (name = &quot;KATHERINE A&quot;,
  position = &quot;PERSONAL COMPUTER OPERATOR II&quot;,
  salary = 60780)]
=#</code></pre><p>This includes Julia syntax trees.</p><pre><code class="language-julia">Q = :(
    Employee
    &gt;&gt; ThenFilter(Department &gt;&gt; Name .== &quot;POLICE&quot;)
    &gt;&gt; ThenSort(Salary &gt;&gt; Desc)
    &gt;&gt; ThenSelect(Name, Position, Salary)
    &gt;&gt; ThenTake(10)
)

print_code(Q)
#=&gt;
Employee
&gt;&gt; ThenFilter(Department &gt;&gt; Name .== &quot;POLICE&quot;)
&gt;&gt; ThenSort(Salary &gt;&gt; Desc)
&gt;&gt; ThenSelect(Name, Position, Salary)
&gt;&gt; ThenTake(10)
=#</code></pre><footer><hr/><a class="previous" href="implementation.html"><span class="direction">Previous</span><span class="title">Implementation Guide</span></a><a class="next" href="vectors.html"><span class="direction">Next</span><span class="title">Column Store</span></a></footer></article></body></html>
